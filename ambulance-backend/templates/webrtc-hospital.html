<!DOCTYPE html>
<html>
<head>
    <title>Hospital WebRTC Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .booking-update { background-color: #fff3cd; padding: 10px; margin: 5px 0; border-radius: 5px; }
        #messages { height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; }
    </style>
</head>
<body>
    <h1>Hospital WebRTC Dashboard</h1>
    
    <div id="status" class="status disconnected">Disconnected</div>
    
    <button onclick="connectToUser()">Connect to User</button>
    <button onclick="disconnect()">Disconnect</button>
    
    <h3>Real-time Booking Updates</h3>
    <div id="messages"></div>

    <script>
        class HospitalWebRTC {
            constructor() {
                this.peerConnection = null;
                this.dataChannel = null;
                this.peerId = 'hospital_' + Math.random().toString(36).substr(2, 9);
                this.targetId = null;
                this.pollingInterval = null;
            }

            async initialize(targetId) {
                this.targetId = targetId;

                // Register as hospital peer
                await fetch('https://ambulance-booking-roan.vercel.app/api/webrtc/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        peer_id: this.peerId,
                        peer_type: 'hospital'
                    })
                });

                this.createPeerConnection();
                this.startPolling();
                this.updateStatus('Waiting for connection...');
            }

            createPeerConnection() {
                this.peerConnection = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                });

                this.peerConnection.onicecandidate = (event) => {
                    if (event.candidate && this.targetId) {
                        this.sendIceCandidate(event.candidate);
                    }
                };

                this.peerConnection.ondatachannel = (event) => {
                    const channel = event.channel;
                    this.setupDataChannel(channel);
                };
            }

            setupDataChannel(channel) {
                this.dataChannel = channel;

                channel.onopen = () => {
                    console.log('Data channel opened');
                    this.updateStatus('Connected');
                };

                channel.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.handleBookingUpdate(data);
                    } catch (error) {
                        console.error('Error parsing data channel message:', error);
                    }
                };

                channel.onclose = () => {
                    console.log('Data channel closed');
                    this.updateStatus('Disconnected');
                };
            }

            async handleOffer(offer, fromPeerId) {
                if (!this.peerConnection) return;

                await this.peerConnection.setRemoteDescription(offer);
                const answer = await this.peerConnection.createAnswer();
                await this.peerConnection.setLocalDescription(answer);

                await fetch('https://ambulance-booking-roan.vercel.app/api/webrtc/answer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        peer_id: this.peerId,
                        target_id: fromPeerId,
                        answer: answer
                    })
                });
            }

            async handleAnswer(answer) {
                if (!this.peerConnection) return;
                await this.peerConnection.setRemoteDescription(answer);
            }

            async handleIceCandidate(candidate) {
                if (!this.peerConnection) return;
                await this.peerConnection.addIceCandidate(candidate);
            }

            async sendIceCandidate(candidate) {
                if (!this.targetId) return;

                await fetch('https://ambulance-booking-roan.vercel.app/api/webrtc/ice-candidate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        peer_id: this.peerId,
                        target_id: this.targetId,
                        candidate: candidate
                    })
                });
            }

            startPolling() {
                this.pollingInterval = setInterval(async () => {
                    try {
                        const response = await fetch(`https://ambulance-booking-roan.vercel.app/api/webrtc/messages/${this.peerId}`);
                        const data = await response.json();

                        for (const message of data.messages) {
                            switch (message.type) {
                                case 'offer':
                                    await this.handleOffer(message.offer, message.from);
                                    break;
                                case 'answer':
                                    await this.handleAnswer(message.answer);
                                    break;
                                case 'ice-candidate':
                                    await this.handleIceCandidate(message.candidate);
                                    break;
                            }
                        }

                        // Send heartbeat
                        await fetch('https://ambulance-booking-roan.vercel.app/api/webrtc/heartbeat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ peer_id: this.peerId })
                        });
                    } catch (error) {
                        console.error('Polling error:', error);
                    }
                }, 1000);
            }

            handleBookingUpdate(data) {
                const messagesDiv = document.getElementById('messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'booking-update';
                
                if (data.type === 'booking_update') {
                    messageDiv.innerHTML = `
                        <strong>New Booking Update</strong><br>
                        <strong>Time:</strong> ${new Date(data.timestamp).toLocaleString()}<br>
                        <strong>Data:</strong> ${JSON.stringify(data.data, null, 2)}
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <strong>Message:</strong> ${JSON.stringify(data, null, 2)}
                    `;
                }
                
                messagesDiv.appendChild(messageDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }

            updateStatus(status) {
                const statusDiv = document.getElementById('status');
                statusDiv.textContent = status;
                statusDiv.className = status === 'Connected' ? 'status connected' : 'status disconnected';
            }

            disconnect() {
                if (this.pollingInterval) {
                    clearInterval(this.pollingInterval);
                }
                
                if (this.dataChannel) {
                    this.dataChannel.close();
                }
                
                if (this.peerConnection) {
                    this.peerConnection.close();
                }
                
                this.updateStatus('Disconnected');
            }
        }

        const hospitalWebRTC = new HospitalWebRTC();

        async function connectToUser() {
            const userId = prompt('Enter User ID to connect to:');
            if (userId) {
                await hospitalWebRTC.initialize(userId);
            }
        }

        function disconnect() {
            hospitalWebRTC.disconnect();
        }
    </script>
</body>
</html>